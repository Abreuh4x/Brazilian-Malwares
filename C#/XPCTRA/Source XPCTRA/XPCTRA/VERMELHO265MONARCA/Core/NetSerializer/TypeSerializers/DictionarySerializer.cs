// Decompiled with JetBrains decompiler
// Type: VERMELHO265MONARCA.Core.NetSerializer.TypeSerializers.DictionarySerializer
// Assembly: madre, Version=1.1.2.3, Culture=neutral, PublicKeyToken=null
// MVID: E3E81F5F-5E79-4C7B-AA1D-713B5D376685
// Assembly location: C:\Users\Marcos Abreu\Documents\XPCTRA\idfptray.exe

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Reflection;

namespace VERMELHO265MONARCA.Core.NetSerializer.TypeSerializers
{
  public class DictionarySerializer : IStaticTypeSerializer, ITypeSerializer
  {
    public bool Handles(Type type)
    {
      if (!type.IsGenericType)
        return false;
      return type.GetGenericTypeDefinition() == typeof (Dictionary<,>);
    }

    public IEnumerable<Type> GetSubtypes(Type type)
    {
      Type[] genArgs = type.GetGenericArguments();
      Type serializedType = typeof (KeyValuePair<,>).MakeGenericType(genArgs).MakeArrayType();
      yield return serializedType;
    }

    public void GetStaticMethods(Type type, out MethodInfo writer, out MethodInfo reader)
    {
      Debug.Assert(type.IsGenericType);
      if (!type.IsGenericType)
        throw new Exception();
      Type genericTypeDefinition = type.GetGenericTypeDefinition();
      Debug.Assert(genericTypeDefinition == typeof (Dictionary<,>));
      Type type1 = this.GetType();
      writer = DictionarySerializer.GetGenWriter(type1, genericTypeDefinition);
      reader = DictionarySerializer.GetGenReader(type1, genericTypeDefinition);
      Type[] genericArguments = type.GetGenericArguments();
      writer = writer.MakeGenericMethod(genericArguments);
      reader = reader.MakeGenericMethod(genericArguments);
    }

    private static MethodInfo GetGenWriter(Type containerType, Type genType)
    {
      foreach (MethodInfo methodInfo in ((IEnumerable<MethodInfo>) containerType.GetMethods(BindingFlags.Static | BindingFlags.Public)).Where<MethodInfo>((Func<MethodInfo, bool>) (mi =>
      {
        if (mi.IsGenericMethod)
          return mi.Name == "WritePrimitive";
        return false;
      })))
      {
        ParameterInfo[] parameters = methodInfo.GetParameters();
        if (parameters.Length == 3 && parameters[1].ParameterType == typeof (Stream))
        {
          Type parameterType = parameters[2].ParameterType;
          if (parameterType.IsGenericType)
          {
            Type genericTypeDefinition = parameterType.GetGenericTypeDefinition();
            if (genType == genericTypeDefinition)
              return methodInfo;
          }
        }
      }
      return (MethodInfo) null;
    }

    private static MethodInfo GetGenReader(Type containerType, Type genType)
    {
      foreach (MethodInfo methodInfo in ((IEnumerable<MethodInfo>) containerType.GetMethods(BindingFlags.Static | BindingFlags.Public)).Where<MethodInfo>((Func<MethodInfo, bool>) (mi =>
      {
        if (mi.IsGenericMethod)
          return mi.Name == "ReadPrimitive";
        return false;
      })))
      {
        ParameterInfo[] parameters = methodInfo.GetParameters();
        if (parameters.Length == 3 && parameters[1].ParameterType == typeof (Stream))
        {
          Type parameterType = parameters[2].ParameterType;
          if (parameterType.IsByRef)
          {
            Type elementType = parameterType.GetElementType();
            if (elementType.IsGenericType)
            {
              Type genericTypeDefinition = elementType.GetGenericTypeDefinition();
              if (genType == genericTypeDefinition)
                return methodInfo;
            }
          }
        }
      }
      return (MethodInfo) null;
    }

    public static void WritePrimitive<TKey, TValue>(Serializer serializer, Stream stream, Dictionary<TKey, TValue> value)
    {
      KeyValuePair<TKey, TValue>[] keyValuePairArray = new KeyValuePair<TKey, TValue>[value.Count];
      int num = 0;
      foreach (KeyValuePair<TKey, TValue> keyValuePair in value)
        keyValuePairArray[num++] = keyValuePair;
      serializer.Serialize(stream, (object) keyValuePairArray);
    }

    public static void ReadPrimitive<TKey, TValue>(Serializer serializer, Stream stream, out Dictionary<TKey, TValue> value)
    {
      KeyValuePair<TKey, TValue>[] keyValuePairArray = (KeyValuePair<TKey, TValue>[]) serializer.Deserialize(stream);
      value = new Dictionary<TKey, TValue>(keyValuePairArray.Length);
      foreach (KeyValuePair<TKey, TValue> keyValuePair in keyValuePairArray)
        value.Add(keyValuePair.Key, keyValuePair.Value);
    }
  }
}
